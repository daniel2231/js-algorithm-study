# .github/workflows/update-progress.yml
name: Update Study Progress

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch: 

jobs:
  update-progress:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Create progress update script
      run: |
        cat > update-progress.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // ì„¤ì •
        const WEEKS = 16;
        const PROBLEMS_PER_WEEK = 2;
        const README_PATH = 'README.md';

        // ë©¤ë²„ í´ë” ìŠ¤ìº”
        function getMembers() {
          const items = fs.readdirSync('.', { withFileTypes: true });
          return items
            .filter(item => item.isDirectory() && 
                          !item.name.startsWith('.') && 
                          !['node_modules', 'docs', 'resources'].includes(item.name))
            .map(item => item.name)
            .sort();
        }

        // ì£¼ì°¨ë³„ íŒŒì¼ ê°œìˆ˜ ì²´í¬
        function countWeekFiles(member, week) {
          const weekPath = path.join(member, `week${week.toString().padStart(2, '0')}`);
          
          if (!fs.existsSync(weekPath)) {
            return 0;
          }
          
          const files = fs.readdirSync(weekPath);
          // .js íŒŒì¼ë§Œ ì¹´ìš´íŠ¸
          return files.filter(file => file.endsWith('.js')).length;
        }

        // ì§„ë„ ìƒíƒœ ì´ëª¨ì§€ ë°˜í™˜
        function getStatusEmoji(completed, total) {
          if (completed >= total) return 'âœ…';
          if (completed > 0) return 'âš ï¸';
          return 'âŒ';
        }

        // ì§„ë„ í˜„í™© í…Œì´ë¸” ìƒì„±
        function generateProgressTable() {
          const members = getMembers();
          
          if (members.length === 0) {
            return 'ì•„ì§ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤. í´ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.';
          }

          let table = '| ì£¼ì°¨ |';
          members.forEach(member => {
            table += ` ${member} |`;
          });
          table += '\n|------|';
          members.forEach(() => {
            table += '-------|';
          });
          table += '\n';

          for (let week = 1; week <= WEEKS; week++) {
            table += `| ${week}ì£¼ |`;
            
            members.forEach(member => {
              const completed = countWeekFiles(member, week);
              const status = getStatusEmoji(completed, PROBLEMS_PER_WEEK);
              table += ` ${status} ${completed}/${PROBLEMS_PER_WEEK} |`;
            });
            
            table += '\n';
          }

          // ë²”ë¡€ ì¶”ê°€
          table += '\n**ë²”ë¡€:**\n';
          table += '- âœ… 2/2: ì™„ë£Œ\n';
          table += '- âš ï¸ 1/2: ì§„í–‰ì¤‘  \n';
          table += '- âŒ 0/2: ë¯¸ì™„ë£Œ\n\n';
          
          // ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€
          const now = new Date();
          const kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // KST ë³€í™˜
          table += `**ìµœì¢… ì—…ë°ì´íŠ¸:** ${kstTime.toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}`;

          return table;
        }

        // README.md ì—…ë°ì´íŠ¸
        function updateReadme() {
          if (!fs.existsSync(README_PATH)) {
            console.log('README.md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            return false;
          }

          let content = fs.readFileSync(README_PATH, 'utf8');
          const progressTable = generateProgressTable();

          // PROGRESS_STARTì™€ PROGRESS_END ì‚¬ì´ì˜ ë‚´ìš©ì„ êµì²´
          const startMarker = '<!-- PROGRESS_START -->';
          const endMarker = '<!-- PROGRESS_END -->';
          
          const startIndex = content.indexOf(startMarker);
          const endIndex = content.indexOf(endMarker);
          
          if (startIndex === -1 || endIndex === -1) {
            console.log('ì§„ë„ í˜„í™© ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
          }

          const beforeMarker = content.substring(0, startIndex + startMarker.length);
          const afterMarker = content.substring(endIndex);
          
          const newContent = beforeMarker + '\n' + progressTable + '\n' + afterMarker;
          
          fs.writeFileSync(README_PATH, newContent, 'utf8');
          console.log('README.mdê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          return true;
        }

        // í†µê³„ ì¶œë ¥
        function printStatistics() {
          const members = getMembers();
          console.log(`\nğŸ“Š ìŠ¤í„°ë”” í˜„í™©:`);
          console.log(`- ë©¤ë²„ ìˆ˜: ${members.length}ëª…`);
          console.log(`- ë©¤ë²„: ${members.join(', ')}`);
          
          members.forEach(member => {
            let totalCompleted = 0;
            for (let week = 1; week <= WEEKS; week++) {
              totalCompleted += countWeekFiles(member, week);
            }
            const totalPossible = WEEKS * PROBLEMS_PER_WEEK;
            const percentage = ((totalCompleted / totalPossible) * 100).toFixed(1);
            console.log(`- ${member}: ${totalCompleted}/${totalPossible} (${percentage}%)`);
          });
        }

        function main() {
          console.log('ğŸ”„ ì§„ë„ í˜„í™© ì—…ë°ì´íŠ¸ ì‹œì‘...');
          
          const success = updateReadme();
          if (success) {
            printStatistics();
            console.log('âœ… ì§„ë„ í˜„í™© ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
          } else {
            console.log('âŒ ì§„ë„ í˜„í™© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
            process.exit(1);
          }
        }

        main();
        EOF

    - name: Run progress update
      run: node update-progress.js
      
    - name: Check for changes
      id: verify-changed-files
      run: |
        if git diff --exit-code README.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git commit -m "ğŸ“Š ìë™ ì—…ë°ì´íŠ¸: ìŠ¤í„°ë”” ì§„ë„ í˜„í™© ê°±ì‹ "
        git push
        
    - name: Summary
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "âœ… README.md ì§„ë„ í˜„í™©ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“Š ìµœì‹  ì§„ë„ í˜„í™©ì„ í™•ì¸í•´ë³´ì„¸ìš”."
        
    - name: No changes
      if: steps.verify-changed-files.outputs.changed == 'false'
      run: |
        echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
